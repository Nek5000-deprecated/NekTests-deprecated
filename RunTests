#! /bin/sh

#Create Directories 
mkdir tools
mkdir mpiLog;  mkdir mpi2Log
mkdir gnuLog;  mkdir gnu2Log
mkdir intLog;  mkdir int2Log
mkdir pgiLog;  mkdir pgi2Log


#Create variable to store source path for tools
cd tools
HERE_T=`pwd`


##############################################################
##############################################################
#Test all Compilers for Pn-Pn Case
#Builds tools with all compilers
##############################################################
##############################################################
#Build tools with pgi compiler

cd ../../trunk/tools/
sed -e "s:^F77*=\"\":F77=\"pgf77\":"  \
-e "s:^CC*=\"\":CC=\"pgcc\":"  maketools >maketools.buildbot
chmod +x maketools.buildbot

cd prenek
sed -e "s:1 000 000:10 000:" basics.inc>t.t
mv t.t basics.inc

cd ../
maketools.buildbot all     $HERE_T  | tee ../../tests/pgitools.out
##############################################################
#Test MPI Compiler

cp ../nek/makenek ../nek/makenek.bb
chmod +x ../nek/makenek.bb

cd ../../
sed -i "s:lx2=:lx2=lx1)      \!:"  */*/SIZE
sed -i "s:ly2=:ly2=ly1)      \!:"  */*/SIZE
sed -i "s:lz2=:lz2=lz1)      \!:"  */*/SIZE
cd tests/test0001/
sed "s/^.*DIVERGENCE$/  0.10000E-08/" test0001.rea > n.rea      
mv n.rea test0001.rea
cd ../../trunk/nek
 
rm -rf ../../examples/*/*.map
../../tests/ExTestmpi

#Find all log files and error files and put into directory
mv ../../examples/*/*log.*     ../../tests/mpiLog
mv ../../examples/*/*.err*     ../../tests/mpiLog
mv ../../tests/test0001/*log.* ../../tests/mpiLog
##############################################################
#Test PG Compiler

sed -e "s:^F77*=\"mpif77\":F77=\"pgf77\":"  \
-e "s:^CC*=\"mpicc\":CC=\"pgcc\":"  \
-e "s:\#IFMPI*=:IFMPI=:"  makenek >makenek.bb

../../tests/ExTest

#Find all log files and error files and put into directory
mv ../../examples/*/*log.*     ../../tests/pgiLog
mv ../../examples/*/*.err*     ../../tests/pgiLog
##############################################################
##############################################################
#Build tools with gnu compiler

cd ../tools/
sed -e "s:^F77*=\"\":F77=\"gfortran\":"  \
-e "s:^CC*=\"\":CC=\"gcc\":"  maketools >maketools.buildbot
chmod +x maketools.buildbot

maketools.buildbot clean            $HERE_T

cd prenek
sed -e "s:1 000 000:10 000:" basics.inc>t.t
mv t.t basics.inc

cd ../
maketools.buildbot all     $HERE_T  | tee ../../tests/gnutools.out
##############################################################
#Test GNU Compiler

cd ../nek
sed -e "s:^F77*=\"mpif77\":F77=\"gfortran\":"  \
-e "s:^CC*=\"mpicc\":CC=\"gcc\":"  \
-e "s:\#IFMPI*=:IFMPI=:"  makenek >makenek.bb

rm -rf ../../examples/*/*.map
../../tests/ExTest

#Find all log files and error files and put into directory
mv ../../examples/*/*log.*     ../../tests/gnuLog
mv ../../examples/*/*.err*     ../../tests/gnuLog
##############################################################
##############################################################
#Build tools with intel compiler

cd ../tools/
sed -e "s:^F77*=\"\":F77=\"ifort\":"  \
-e "s:^CC*=\"\":CC=\"icc\":"  maketools >maketools.buildbot
chmod +x maketools.buildbot

maketools.buildbot clean           $HERE_T

cd prenek
sed -e "s:1 000 000:10 000:" basics.inc>t.t
mv t.t basics.inc

cd ../
maketools.buildbot all     $HERE_T  | tee ../../tests/inttools.out
##############################################################
#Test INTEL Compiler

cd ../nek
sed -e "s:^F77*=\"mpif77\":F77=\"ifort\":"  \
-e "s:^CC*=\"mpicc\":CC=\"icc\":"  \
-e "s:\#IFMPI*=:IFMPI=:"  makenek >makenek.bb

#Tweak Intel Compiler Specific 
cd ../../examples/eddy/
sed "s/^.*DIVERGENCE$/  0.10000E-08/" eddy_uv.rea > n.rea      
mv n.rea eddy_uv.rea
cd ../lowMach_test
sed "s/^.*IFNAV.*$/  T T IFNAV & IFADVC/" lowMach_test.rea > n.rea
mv n.rea lowMach_test.rea
cd ../../trunk/nek

rm -rf ../../examples/*/*.map
../../tests/ExTest

#Find all log files and error files and put into directory
mv ../../examples/*/*log.*     ../../tests/intLog
mv ../../examples/*/*.err*     ../../tests/intLog
##############################################################
##############################################################
#Test all Compilers for Pn-Pn-2 Case
##############################################################
##############################################################
#Test MPI Compiler

cp makenek makenek.bb

cd ../../
sed -i "s:lx2=:lx2=lx1-2)      \!:"  */*/SIZE
sed -i "s:ly2=:ly2=ly1-2)      \!:"  */*/SIZE
sed -i "s:lz2=:lz2=lz1-2)      \!:"  examples/vortex/SIZE
sed -i "s:lz2=:lz2=lz1-2)      \!:"  examples/peris/SIZE
sed -i "s:lz2=:lz2=lz1-2)      \!:"  examples/pipe/SIZE
sed -i "s:lz2=:lz2=lz1-2)      \!:"  examples/turbChannel/SIZE
cd ./trunk/nek

../../tests/ExTestmpi

#Find all log files and error files and put into directory
mv ../../examples/*/*log.*     ../../tests/mpi2Log
mv ../../examples/*/*.err*     ../../tests/mpi2Log
mv ../../tests/test0001/*log.* ../../tests/mpi2Log
##############################################################
#Test PG Compiler

sed -e "s:^F77*=\"mpif77\":F77=\"pgf77\":"  \
-e "s:^CC*=\"mpicc\":CC=\"pgcc\":"  \
-e "s:\#IFMPI*=:IFMPI=:"  makenek >makenek.bb

../../tests/ExTest

#Find all log files and error files and put into directory
mv ../../examples/*/*log.*     ../../tests/pgi2Log
mv ../../examples/*/*.err*     ../../tests/pgi2Log
##############################################################
#Test GNU Compiler

sed -e "s:^F77*=\"mpif77\":F77=\"gfortran\":"  \
-e "s:^CC*=\"mpicc\":CC=\"gcc\":"  \
-e "s:\#IFMPI*=:IFMPI=:"  makenek >makenek.bb

../../tests/ExTest

#Find all log files and error files and put into directory
mv ../../examples/*/*log.*     ../../tests/gnu2Log
mv ../../examples/*/*.err*     ../../tests/gnu2Log
##############################################################
#Test INTEL Compiler

sed -e "s:^F77*=\"mpif77\":F77=\"ifort\":"  \
-e "s:^CC*=\"mpicc\":CC=\"icc\":"  \
-e "s:\#IFMPI*=:IFMPI=:"  makenek >makenek.bb

../../tests/ExTest

#Find all log files and error files and put into directory
mv ../../examples/*/*log.*     ../../tests/int2Log
mv ../../examples/*/*.err*     ../../tests/int2Log
##############################################################
