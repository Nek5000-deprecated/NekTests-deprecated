#! /bin/sh

#Create Directories 
mkdir tools
mkdir mpiLog
mkdir gnuLog
mkdir intLog
mkdir pgiLog


#Create variable to store source path for tools
cd tools
HERE_T=`pwd`


#Set Fortran&C compiler and build tools
cd ../../trunk/tools/
sed -e "s:^F77*=\"\":F77=\"pgf77\":"  \
-e "s:^CC*=\"\":CC=\"pgcc\":"  maketools >maketools.buildbot
chmod +x maketools.buildbot

cd prenek
sed -e "s:1 000 000:10 000:" basics.inc>t.t
mv t.t basics.inc

cd ../
maketools.buildbot all              $HERE_T


#Test MPI Compiler
cp ../nek/makenek ../nek/makenek.bb
chmod +x ../nek/makenek.bb

../../tests/ExTest
#Parallel Tests for MPI
cd ../../tests/test0001
./neklmpi test0001 4

cd ../../examples/axi
./neklmpi axi 4

cd ../conj_ht
./neklmpi conj_ht 4
grep "tmax" conj_ht.log.4 | tail -1 > conj_ht.err.4

cd ../eddy
./neklmpi eddy_uv 4
grep "err" eddy_uv.log.4 | tail -4 > eddy_uv.err.4

cd ../fs_2
./nek200steps st1 4
grep "amp" st1.log.4 | tail -1 > st1.err.4
./nek200steps st2 4
grep "amp" st2.log.4 | tail -1 > st2.err.4
./nek200steps std_wv 4
grep "amp" std_wv.log.4 | tail -1 > std_wv.err.4

cd ../fs_hydro
./nek200steps fs_hydro 4
grep "AMP" fs_hydro.log.4 | tail -1 > fs_hydro.err.4

cd ../kovasznay
./neklmpi kov 4
grep "err" kov.log.4 | tail -1 > kov.err.4

cd ../lowMach_test
./nek200steps lowMach_test 4
grep "ERROR" lowMach_test.log.4 | tail -3 > lowMach_test.err.4

cd ../peris
./nek10steps peris 4

cd ../pipe
./nek10steps helix 4
grep "err2" helix.log.4 | tail -1 > helix.err.4
./nek10steps stenosis 4

cd ../rayleigh
./nek200steps ray1 4
grep "umax" ray1.log.4 | tail -1 > ray1.err.4
./nek200steps ray2 4
grep "umax" ray2.log.4 | tail -1 > ray2.err.4

cd ../shear4
./nek10steps shear4 4
./nek10steps thin 4

cd ../turbChannel
./nek10steps turbChannel 4
grep "err2" turbChannel.log.4 | tail -1 > turbChannel.err.4



#Find all log files and error files and put into directory
cd ..
mv */*log.* ../tests/mpiLog
mv */*.err* ../tests/mpiLog
cd ../tests/test0001
mv *log.*   ../mpiLog
##############################################################
#Test PG Compiler
cd ../../trunk/nek/
sed -e "s:^F77*=\"mpif77\":F77=\"pgf77\":"  \
-e "s:^CC*=\"mpicc\":CC=\"pgcc\":"  \
-e "s:\#IFMPI*=:IFMPI=:"  makenek >makenek.bb
#chmod +x makenek.bb

../../tests/ExTest

#Find all log files and error files and put into directory
cd ../../examples
mv */*log.* ../tests/pgiLog
mv */*.err* ../tests/pgiLog
cd ../tests/test0001
mv *log.*   ../pgiLog
##############################################################
#Test GNU Compiler
cd ../../trunk/nek/
sed -e "s:^F77*=\"mpif77\":F77=\"gfortran\":"  \
-e "s:^CC*=\"mpicc\":CC=\"gcc\":"  \
-e "s:\#IFMPI*=:IFMPI=:"  makenek >makenek.bb
#chmod +x makenek.bb

../../tests/ExTest

#Find all log files and error files and put into directory
cd ../../examples
mv */*log.* ../tests/gnuLog
mv */*.err* ../tests/gnuLog
cd ../tests/test0001
mv *log.*   ../gnuLog
##############################################################
#Test INTEL Compiler
cd ../../trunk/nek/
sed -e "s:^F77*=\"mpif77\":F77=\"ifort\":"  \
-e "s:^CC*=\"mpicc\":CC=\"icc\":"  \
-e "s:\#IFMPI*=:IFMPI=:"  makenek >makenek.bb
#chmod +x makenek.bb

../../tests/ExTest

#Find all log files and error files and put into directory
cd ../../examples
mv */*log.* ../tests/intLog
mv */*.err* ../tests/intLog
cd ../tests/test0001
mv *log.*   ../intLog
##############################################################

